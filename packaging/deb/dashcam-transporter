#!/bin/sh
set -eu

APP_NAME="dashcam-transporter"
REPO_DEFAULT="steve192/dashcam-transporter"
REPO="${DASHCAM_TRANSPORTER_REPO:-$REPO_DEFAULT}"
ARCH="$(dpkg --print-architecture)"
BASE_URL_DEFAULT="https://github.com/${REPO}/releases/latest/download"
BASE_URL="${DASHCAM_TRANSPORTER_RELEASE_BASE:-$BASE_URL_DEFAULT}"
LOG_FILE="/var/log/dashcam-transporter/app.log"

usage() {
  cat <<USAGE
Usage: dashcam-transporter <command>

Commands:
  update   Download and install the latest .deb for this architecture
  status   Show service status
  logs     Tail recent logs
USAGE
}

require_root() {
  if [ "$(id -u)" -ne 0 ]; then
    exec sudo -- "$0" "$@"
  fi
}

update() {
  case "$ARCH" in
    armhf|arm64|amd64) ;;
    *)
      echo "Unsupported architecture: $ARCH" >&2
      exit 1
      ;;
  esac

  asset="${APP_NAME}_${ARCH}.deb"
  url="${BASE_URL}/${asset}"
  tmp="$(mktemp -t ${APP_NAME}.XXXXXX.deb)"

  cleanup() {
    rm -f "$tmp"
  }
  trap cleanup EXIT

  echo "Downloading $url"
  curl -fsSL "$url" -o "$tmp"

  echo "Installing $asset"
  if command -v apt-get >/dev/null 2>&1; then
    apt-get update
    apt-get install -y "$tmp"
  else
    dpkg -i "$tmp"
  fi
}

show_status() {
  if command -v systemctl >/dev/null 2>&1; then
    systemctl status --no-pager dashcam-transporter
  else
    echo "systemctl not available"
    exit 1
  fi
}

show_logs() {
  if [ -f "$LOG_FILE" ]; then
    tail -n 200 "$LOG_FILE"
    exit 0
  fi

  if command -v journalctl >/dev/null 2>&1; then
    journalctl -u dashcam-transporter --no-pager -n 200
    exit 0
  fi

  echo "No logs available"
  exit 1
}

command="${1:-}"
case "$command" in
  update)
    shift
    require_root update "$@"
    update
    ;;
  status)
    show_status
    ;;
  logs)
    show_logs
    ;;
  -h|--help|help|"")
    usage
    ;;
  *)
    echo "Unknown command: $command" >&2
    usage
    exit 1
    ;;
 esac
